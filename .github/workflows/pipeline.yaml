---
# This is an a CI pipeline
name: main
# Controls when the workflow run
on:
  push:
    # Triggers the workflow for feature branches and main branch
    branches:
      - "feature/*"
      - "main"
# Run build, linting, security and unit testing in parallel,
# and in the main branch only create a release
jobs:
  # Build project.
  Build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Warming
        run: make warming
      - name: Build
        run: make build
  # Linting check
  Linting:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Warming
        run: make warming
      - name: Linting
        run: make linting
  # Security check
  Security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Warming
        run: make warming
      # Build AWS CDK output
      - name: Build
        run: make build
      # We use a dedicated action for the security check
      # https://github.com/stelligent/cfn_nag
      - name: Security
        uses: stelligent/cfn_nag@master
        with:
          input_path: ./cdk.out
          extra_args: -t ..*\.template\.json
      # https://github.com/stelligent/cfn_nag/issues/582
      - name: Fail if cfn_nag scan contains failures
        # sum cfn_nag failures and return it as exit code
        run: |
          exit `grep Failures cfn_nag.out | awk '{ SUM += $3} END { print SUM }'`
  # Unit tests
  UnitTest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Warming
        run: make warming
      - name: Unit tests
        run: make unittest
  # Release creation
  Release:
    # Move forward only if all jobs above are successed
    needs: [Build, Linting, Security, UnitTest]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Getting current release ID"
          response=$(curl \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            https://api.github.com/repos/aws-samples/aws-codepipeline-cicd/releases/latest)
          id=$(echo ${response} | jq '.id')
          echo "Release ID is: ${id}"
          echo "Deleting release"
          curl \
            -X DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/aws-samples/aws-codepipeline-cicd/releases/${id}"
          echo "Creating a new release"
          curl \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: token <TOKEN>" \
            https://api.github.com/repos/aws-samples/aws-codepipeline-cicd/releases \
            -d '{"tag_name":"v1.0.0","target_commitish":"main","name":"Code","body":"Automatic release"}'
